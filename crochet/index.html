<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colorful Grid with Images and Links</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <style>
        body {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
            height: 100vh;
            margin: 0;
        }

        .square {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            aspect-ratio: 1 / 1;
            cursor: pointer;
            transition: filter 0.3s ease-in-out;
            position: relative;
        }

        .modal-content img {
            max-width: 100%;
            max-height: 80vh;
            margin: auto;
            display: block;
        }

        .image-link {
            display: block;
            margin-top: 10px;
        }

        .reset-button {
            display: block;
            margin-top: 10px;
        }

        .grayscale {
            filter: grayscale(100%);
        }

        .square img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .number {
            position: absolute;
        }
    </style>
</head>
<body>
    <div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <a id="modalLink" class="image-link" target="_blank">
                    <img id="modalImage" class="img-fluid" alt="Modal Image">
                </a>
                <button id="resetButton" class="btn btn-primary reset-button">Reset</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const colors = ['#FF595E', '#FF924C', '#FFCA3A', '#C5CA30', '#8AC926', '#36949D', '#1982C4', '#4267AC', '#565AA0', '#6A4C93'];
            const gridContainer = document.body;
            const links = {};
            const grayscaleClass = 'grayscale';
            let lastClickedSquare = null;
            let resetButtonPressed = false;

            fetch('links.csv')
                .then(response => response.text())
                .then(csvData => {
                    const rows = csvData.split('\n').slice(1);
                    rows.forEach(row => {
                        const [link, number] = row.split(',');
                        links[parseInt(number)] = link.trim();
                    });

                    for (let row = 0; row < 10; row++) {
                        const rowColors = getUniqueColors(colors);
                        for (let col = 1; col <= 10; col++) {
                            const square = document.createElement("div");
                            square.classList.add("square");
                            square.textContent = col + row * 10;
                            square.style.backgroundColor = rowColors[col - 1];

                            const squareId = col + row * 10;
                            const isGrayscale = localStorage.getItem(`grayscale_${squareId}`);
                            if (isGrayscale === 'true') {
                                square.classList.add(grayscaleClass);
                            }

                            const storedImage = localStorage.getItem(`image_${squareId}`);
                            if (storedImage) {
                                const squareImage = document.createElement("img");
                                squareImage.src = storedImage;
                                squareImage.classList.add("img-fluid");
                                squareImage.alt = "Square Image";

                                const number = square.textContent;
                                square.innerHTML = '';
                                square.appendChild(squareImage);
                                square.innerHTML += `<div class="number">${number}</div>`;
                            }

                            square.addEventListener("click", function () {
                                const imageNumber = parseInt(this.textContent);
                                displayModalImage(imageNumber);
                                lastClickedSquare = this;
                                resetButtonPressed = false;
                            });

                            gridContainer.appendChild(square);
                        }
                    }
                })
                .catch(error => console.error('Error fetching CSV file:', error));

            function getUniqueColors(colorArray) {
                const shuffledColors = shuffleArray(colorArray.slice());
                return [...shuffledColors, ...shuffledColors];
            }

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function displayModalImage(imageNumber) {
                const modalImage = document.getElementById("modalImage");
                const modalLink = document.getElementById("modalLink");

                modalImage.src = `images/${imageNumber}.jpg`;
                modalLink.href = links[imageNumber] || '#';

                // Listen for modal close event to update the last clicked square with the image
                $('#imageModal').on('hidden.bs.modal', function () {
                    if (lastClickedSquare && !resetButtonPressed) {
                        const squareImage = document.createElement("img");
                        squareImage.src = `images/${imageNumber}.jpg`;
                        squareImage.classList.add("img-fluid");
                        squareImage.alt = "Square Image";

                        const number = lastClickedSquare.textContent;
                        lastClickedSquare.innerHTML = '';
                        lastClickedSquare.appendChild(squareImage);
                        lastClickedSquare.innerHTML += `<div class="number">${number}</div>`;
                        lastClickedSquare.classList.remove(grayscaleClass);

                        const squareId = parseInt(lastClickedSquare.textContent);
                        localStorage.setItem(`image_${squareId}`, squareImage.src);
                        localStorage.setItem(`grayscale_${squareId}`, 'false');
                    }
                });

                // Trigger modal show manually
                $('#imageModal').modal('show');

                // Attach event listener for the reset button
                const resetButton = document.getElementById('resetButton');
                resetButton.addEventListener('click', function () {
                    resetButtonPressed = true;
                    if (lastClickedSquare) {
                        const number = lastClickedSquare.textContent;
                        lastClickedSquare.innerHTML = `<div class="number">${number}</div>`;
                        lastClickedSquare.classList.remove(grayscaleClass);

                        const squareId = parseInt(lastClickedSquare.textContent);
                        localStorage.removeItem(`image_${squareId}`);
                        localStorage.setItem(`grayscale_${squareId}`, 'false');
                    }
                });
            }
        });
    </script>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
</body>
</html>
